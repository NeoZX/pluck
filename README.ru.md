[EN](README.md) [RU](README.ru.md)

# Зачем Вам это нужно
Данная утилита разработана для уменьшения размера файла БД [Firebird](https://firebirdsql.org/) без выполнения операций бекапа и восстановления.

# Как это работает
На первом этапе утилита ищет свободные страницы по данным PIP (Page Inventory Page) и освобождает блоки файловой системы на свободных страницах. 

На втором этапе утилита анализирует использование страниц. Если на странице есть не используемые блоки, тогда эти блоки освобождаются. Анализируются страницы следующих типов: данные, b-tree индекс, BLOB. Эти три типа страниц составляют >99% от общего количества страниц в больших базах данных. 

При освобождении блока на уровне файловой системе на блочное устройство отправляется команда trim. Возможно так же потребуется выполнить команду fstrim. Это зависит от настроек монтирования файловой системы, смотрите описание опции discard в документации по файловой системе.

Не рекомендуется использовать на HDD, так как использование утилиты может приводить к фрагментации файла. На SSD фрагментация файла практически не влияет на скорость чтения/записи и время доступа.

# ПРЕДОСТЕРЕЖЕНИЯ
Уменьшение размера файла базы данных может быть полезно в некоторых случаях. Например, если в базе данных выполняются в основном читающие транзакции (в OLAP моделях, аналитика, статистика и т.п.). Но возможна ситуация, когда размер файла будет больше размера ФС. Таким образом возникнет ситуация при которой на ФС нет свободных блоков, но в файле есть свободные страницы. Такая ситуация может приводить к непредвиденным ошибкам в работе СУБД. 

# Требования
* Операционная система Linux x86_64
* glibс 2.18 (поддержка флагов FALLOC_FL_*)
* kernel 2.6.38 если используется файловая система XFS
* kernel 3.0 если используется файловая система Ext4

# Пример использования
Запуск в режиме dry-run:

    ./pluck -f database.fdb

Запуск с освобождением блоков:

    ./pluck -t -f database.fdb

Запуск с освобождением блоков в 4 потока:

    ./pluck -p 4 -t -f database.fdb

Перед запуском необходимо заблокировать возможность изменения файла процессами Firebird. Для этого нужно сделать shutdown БД или перевести БД в backup mode.

# Ограничения
* БД из нескольких файлов не поддерживаются.
* Поддерживается структура БД ODS11, ODS12, ODS13, используемые в Firebird 2/3/4.
* Шифрованные файлы БД Ред Базы Данных 2.6 не поддерживаются.
* Шифрованные файлы БД Firebird 3/4 поддерживаются только на первом этапе.
* Поддерживается размер блока файловой системы 512 и 4096, по умолчанию 4096.
* Поддерживаемые ОС Linux. 

# Альтернативы
В качестве альтернативы можно использовать системные команды операционной системы, например скопировать файл с опцией sparse:

    cp --sparse=always original.fdb sparse.fdb

Это будет менее эффективно, но тоже позволит уменьшить размер файла.
